<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}

    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:6px;padding:10px;grid-template-columns:1fr}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:8px 10px;margin:2px 0;cursor:pointer;font-size:14px;line-height:1.28}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px}

    .login-card{width:min(420px,92vw);margin:0 auto}
    #extraInfo { max-height:50vh; overflow:auto; resize:vertical; }
    .score{font-size:36px;font-weight:800}
  </style>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc,
      deleteDoc, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8uvt7bkZokVkHT7nO0QRaB9WpEe2g2C4",
      authDomain: "youth-worker.firebaseapp.com",
      projectId: "youth-worker",
      storageBucket: "youth-worker.firebasestorage.app",
      messagingSenderId: "666890915384",
      appId: "1:666890915384:web:2dbc2b4d35aa9e3948a0cd",
      measurementId: "G-GT3X3E9VTB"
    };
        
    try{
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.__cloudReady = true;
      window.__fb = {
        db,
        colShared : () => collection(db, "sharedData"),
        colProgress: () => collection(db, "progress")
      };
      window.__fb_api = { getDoc, getDocs, setDoc, doc, deleteDoc, writeBatch };
      console.log('[firebase] initialized');
    }catch(e){
      console.warn('[firebase] init failed -> fallback to local only', e);
      window.__cloudReady = false;
    }
  </script>

  <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ì‹¤íŒ¨ ì‹œ ì „ì—­ í´ë°± -->
  <script>
    window.__cloudReady = window.__cloudReady || false;
    window.__fb       = window.__fb       || { db:null, colShared:()=>({}), colProgress:()=>({}) };
    window.__fb_api   = window.__fb_api   || {};
    window.__fb_api.getDocs   = window.__fb_api.getDocs   || (async ()=>({ forEach:()=>{} }));
    window.__fb_api.setDoc    = window.__fb_api.setDoc    || (async ()=>{});
    window.__fb_api.doc       = window.__fb_api.doc       || (/*noop*/()=>({}));
    window.__fb_api.deleteDoc = window.__fb_api.deleteDoc || (async ()=>{});
    window.__fb_api.writeBatch= window.__fb_api.writeBatch|| (/*noop*/()=>({ set(){}, commit:async()=>{} }));
  </script>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>í•™ìŠµì‹œìŠ¤í…œ</h1>
    <div class="spacer"></div>
    <div id="headerRank" class="pill" style="display:none"></div>
    <div id="headerUser" class="pill" style="display:none"></div>
    <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <div class="wrap">
    <!-- ë¡œê·¸ì¸ -->
    <div id="loginPanel" class="panel">
      <div class="login-card" style="padding:20px;display:flex;flex-direction:column;gap:12px">
        <h2>ë¡œê·¸ì¸</h2>
        <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸</button>
        <div id="envErr" style="font-size:12px;color:#ffb3b3;min-height:18px"></div>
        <div id="rankList" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="mainPanel" class="panel" style="display:none">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ 0</div>
          <div class="pill" id="countLearned">ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ 0</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="addQuestionBtn" class="btn">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</button>
          <button id="exportBtn" class="btn">ë‚´ë³´ë‚´ê¸°</button>
          <button id="importBtn" class="btn">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- ì§ˆë¬¸ ëª¨ë‹¬ -->
  <dialog id="qd">
    <div class="dlg">
      <h2 id="qTitle">ì§ˆë¬¸</h2>
      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
        <button id="addAnswerBtn" class="btn">â• ë‹µë³€ ì¶”ê°€</button>
        <button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button>
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>
      <div><div class="answer-box" id="userAnswer"></div></div>
      <div id="result"></div>
      <div id="extraAnswers"></div>

      <hr style="border:0;border-top:1px solid #1f2a55;margin:8px 0">
      <div>
        <h3>ì¶”ê°€ì„¤ëª…</h3>
        <textarea id="extraInfo" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
        <button id="saveExtraInfoBtn" class="btn">ğŸ’¾ ì¶”ê°€ì„¤ëª… ì €ì¥</button>
        <button id="expandExtraInfoBtn" class="btn">ğŸ” ì „ì²´ë³´ê¸°</button>
      </div>
      <div>
        <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
        <div id="followupsBox" class="answer-box" style="min-height:0"></div>
        <div class="row" style="align-items:flex-start">
          <textarea id="fuQ" rows="3" placeholder="ì¶”ê°€ì§ˆë¬¸"></textarea>
          <textarea id="fuA" rows="3" placeholder="ì¶”ê°€ë‹µë³€"></textarea>
          <button id="addFollowupBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    /* ================= ê³µí†µ ìƒíƒœ/ìœ í‹¸ ================= */
    let raw = [];        // ì „ì²´ ë¬¸í•­(ê³µìœ )
    let data = [];       // ë¯¸ìŠµë“ë§Œ í‘œì‹œ
    let currentUser = null;
    let currentIdx = null;
    let recognition = null;

    const LS_SHARED = 'yj_shared_backup_v1';
    const LS_PROG   = 'yj_progress_backup_v1';

    const normSubj = s => (s && String(s).trim()) ? String(s).trim() : 'ê¸°íƒ€';
    const esc = s => String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const qKey = q => `${normSubj(q.subject)}::${q.question}`;

    // ê´€ë¦¬ì íŒë³„
    function isAdminUser(name){ return String(name||'') === 'ê´€ë¦¬ì'; }

    // ====== (ìš”ì²­ì‚¬í•­ìš© ìœ í‹¸) ì •ë‹µ íƒœê·¸ ì²˜ë¦¬ ======
    function ensureTagged(text, author){
      const s = String(text||'').trim();
      return /\s*<[^>]+>\s*$/.test(s) ? s : `${s} <${author}>`;
    }
    function stripAuthorTag(s){
      return String(s||'').replace(/\s*<[^>]+>\s*$/,'').trim();
    }
    function getAuthorFromAnswer(s){
      const m = String(s||'').match(/<([^>]+)>\s*$/);
      return m ? m[1] : 'ê´€ë¦¬ì';
    }
    function stopRecognition(){ try{ recognition && recognition.stop(); }catch{} recognition=null; }

    /* ================= ë¡œì»¬ í´ë°± ì €ì¥ì†Œ ================= */
    function lsGet(key, def){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v): def; }catch{return def;} }
    function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    /* ================= Firestore ì§„ë‹¨ (ì¡°ìš© ëª¨ë“œ) ================= */
    async function pingFirestore(){
      const box = document.getElementById('envErr');
      try{
        if(!window.__cloudReady){ box.textContent=''; return false; }
        const { getDocs } = window.__fb_api;
        await getDocs(window.__fb.colShared());
        box.textContent = '';
        return true;
      }catch(e){
        console.warn('[pingFirestore] Firestore unavailable (silent):', e?.code, e?.message);
        box.textContent = '';
        return false;
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{ pingFirestore(); });

    /* ================= ë°ì´í„° ë¡œë“œ/ì €ì¥ (Cloud-First) ================= */
    async function loadShared(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colShared());
          const arr = []; snap.forEach(d => arr.push(d.data()));
          lsSet(LS_SHARED, arr);
          return arr;
        }catch(e){
          console.warn('[loadShared] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_SHARED, []);
    }
    async function saveShared(array){
      lsSet(LS_SHARED, array);
      if(window.__cloudReady){
        try{
          const { writeBatch, doc } = window.__fb_api;
          const db = window.__fb.db;
          const batch = writeBatch(db);
          array.forEach(rec=>{
            const id = `${normSubj(rec.subject)}::${rec.question}`;
            batch.set(doc(db, "sharedData", id), rec, { merge:true });
          });
          await batch.commit();
        }catch(e){
          console.warn('[saveShared] cloud fail (local kept)', e);
        }
      }
    }
    async function persistQuestion(q){
      const local = lsGet(LS_SHARED, []);
      const id = qKey(q);
      const rec = { subject:q.subject, question:q.question, answers:q.answers||[], active:q.active||0, extraInfo:q.extraInfo||'', followups:q.followups||[] };
      const i = local.findIndex(x=>`${normSubj(x.subject)}::${x.question}`===id);
      if(i>=0) local[i]=rec; else local.push(rec);
      lsSet(LS_SHARED, local);
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db,"sharedData",id), rec, { merge:true });
        }catch(e){ console.warn('[persistQuestion] cloud fail (local kept)', e); }
      }
    }
    async function deleteSharedQuestion(q){
      const id = qKey(q);
      const local = lsGet(LS_SHARED, []);
      lsSet(LS_SHARED, local.filter(x=>`${normSubj(x.subject)}::${x.question}`!==id));
      if(window.__cloudReady){
        try{
          const { deleteDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await deleteDoc(doc(db, "sharedData", id));
        }catch(e){ console.warn('[deleteSharedQuestion] cloud fail (local kept)', e); }
      }
    }

    async function loadProgress(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colProgress());
          const obj = {}; snap.forEach(d => { obj[d.id] = d.data(); });
          lsSet(LS_PROG, obj);
          return obj;
        }catch(e){
          console.warn('[loadProgress] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_PROG, {});
    }
    async function saveProgressForUser(username, learnedIds){
      const local = lsGet(LS_PROG, {});
      local[username] = { learnedIds: Array.from(new Set(learnedIds)) };
      lsSet(LS_PROG, local);
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db, "progress", username), local[username], { merge:true });
        }catch(e){
          console.warn('[saveProgressForUser] cloud fail (local kept)', e);
        }
      }
    }

    /* ================= ê´€ë¦¬ì: ì‚¬ìš©ì ì‚­ì œ ================= */
    async function deleteUser(username){
      if(!isAdminUser(currentUser)){ alert('ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
      if(isAdminUser(username)){ alert('ê´€ë¦¬ìë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(!confirm(`${username} ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      // ë¡œì»¬ ì§„í–‰ë„ ì‚­ì œ
      const prog = lsGet(LS_PROG,{});
      delete prog[username];
      lsSet(LS_PROG, prog);

      // í´ë¼ìš°ë“œ ì§„í–‰ë„ ì‚­ì œ
      if(window.__cloudReady){
        try{
          const { deleteDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await deleteDoc(doc(db,"progress",username));
        }catch(e){ console.warn("cloud delete fail", e); }
      }

      await renderRanks();
      await updateHeaderUser();
    }

    /* ================= ìˆœìœ„/í—¤ë” ================= */
    async function renderRanks(){
      const progress = await loadProgress();

      // ì²« í™”ë©´ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ì—ì„œë§Œ ê´€ë¦¬ì ìˆ¨ê¹€
      const userKeys = Object.keys(progress).filter(u => !isAdminUser(u));

      const total = raw.length || 1;
      const rows = userKeys.map(u=>{
        const learned = (progress[u]?.learnedIds || []).length;
        const rate = ((learned / total) * 100).toFixed(1);
        return { u, learned, rate };
      }).sort((a,b)=> b.learned - a.learned);

      const html = '<h3>í•™ìŠµì ìˆœìœ„</h3>' + (
        rows.length
          ? rows.map((r,i)=>
              `<div>
                 ${i+1}ìœ„ ${esc(r.u)} â€” ìŠµë“ìˆ˜: ${r.learned}, ìŠµë“ìœ¨: ${r.rate}%
                 ${ (isAdminUser(currentUser) && r.u !== currentUser)
                    ? ` <button class="btn danger" onclick="deleteUser('${r.u}')">ğŸ—‘ ì‚­ì œ</button>`
                    : '' }
               </div>`).join('')
          : '<div style="opacity:.7">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
      );
      document.getElementById('rankList').innerHTML = html;
    }
    async function updateHeaderUser(){
      const rankEl = document.getElementById('headerRank');
      const userEl = document.getElementById('headerUser');
      const lo     = document.getElementById('logoutBtn');

      if(!currentUser){
        rankEl.style.display='none';
        userEl.style.display='none';
        lo.style.display='none';
        return;
      }

      const progress = await loadProgress();
      const myLearned = (progress[currentUser]?.learnedIds || []).length;
      const total = raw.length || 1;
      const rate = ((myLearned / total) * 100).toFixed(1);

      const rows = Object.keys(progress).map(u=>({ u, c:(progress[u]?.learnedIds||[]).length }))
                                        .sort((a,b)=> b.c - a.c);
      const idx = rows.findIndex(r=> r.u === currentUser);

      rankEl.textContent = `ì´ë¬¸ì œìˆ˜: ${total} Â· ìŠµë“ìˆ˜: ${myLearned} Â· ìŠµë“ìœ¨: ${rate}% Â· ìˆœìœ„: ${idx>=0? (idx+1)+'ìœ„':'-'}`;
      userEl.textContent = `ì‚¬ìš©ì: ${currentUser}`;

      rankEl.style.display='inline-block';
      userEl.style.display='inline-block';
      lo.style.display    = 'inline-block';
    }

    /* ================= ë² ì´ìŠ¤ ë°ì´í„° ================= */
    const FALLBACK = [
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?', answer:'ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ë¥¼ í˜•ì„±' },
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?', answer:'ë³´í˜¸, ì°¸ì—¬, ë°œë‹¬' }
    ];
    async function loadBase(){
      try{
        const r=await fetch('youth_quiz_data.json',{cache:'no-store'});
        if(!r.ok) throw 0;
        const j=await r.json();
        return Array.isArray(j)&&j.length? j : FALLBACK;
      }catch{ return FALLBACK; }
    }
    // ê¸°ë³¸ answersì— <ê´€ë¦¬ì> íƒœê·¸ ë³´ì¥
    function standardize(base){
      return base.map(x=>{
        const arr = Array.isArray(x.answers) && x.answers.length
          ? x.answers.map(a => ensureTagged(a, 'ê´€ë¦¬ì'))
          : (x.answer ? [ensureTagged(x.answer, 'ê´€ë¦¬ì')] : []);
        return {
          subject : normSubj(x.subject),
          question: x.question,
          answers : arr,
          active  : (typeof x.active==='number'? x.active:0),
          extraInfo: (typeof x.extraInfo==='string')? x.extraInfo : '',
          followups: Array.isArray(x.followups)? x.followups.filter(f=>f&&f.q&&f.a) : []
        };
      });
    }
    async function mergeWithShared(baseStd){
      const map=new Map();
      baseStd.forEach(q=> map.set(qKey(q), {...q}) );
      const shared = await loadShared();
      shared.forEach(q=>{
        const id=qKey(q);
        const sharedAns = (q.answers||[]).map(a => ensureTagged(a, 'ê´€ë¦¬ì'));
        if(map.has(id)){
          const cur=map.get(id);
          const baseAns = (cur.answers||[]).map(a => ensureTagged(a, 'ê´€ë¦¬ì'));
          const merged = [...baseAns];
          sharedAns.forEach(sa=>{ if(!merged.includes(sa)) merged.push(sa); });
          cur.answers = merged;
          if(!cur.extraInfo && q.extraInfo) cur.extraInfo=q.extraInfo;
          const fu=Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a) : [];
          cur.followups=[...(cur.followups||[]), ...fu];
        }else{
          map.set(id,{subject:normSubj(q.subject),question:q.question,answers:sharedAns,active:(q.active||0),extraInfo:(q.extraInfo||''),followups:Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[]});
        }
      });
      raw=Array.from(map.values()).map((q,i)=>({...q,_idx:i}));
      await seedAllAugmentationsThenPersist();
    }
    function makeSeedExtraInfo(q){
      return `â— ì§ˆë¬¸ ì˜ë„: â€œ${q.question}â€ì— ëŒ€í•œ ê°œë… ì´í•´ì™€ í˜„ì¥ ì ìš© ëŠ¥ë ¥ í‰ê°€
â— ë‹µë³€ êµ¬ì¡°: (ì •ì˜) â†’ (í•µì‹¬ìš”ì†Œ 3ê°€ì§€) â†’ (ì‚¬ë¡€/ê·¼ê±°) â†’ (í•œê³„Â·ë³´ì™„/ìœ¤ë¦¬)
â— ë§ë¨¸ë¦¬ ì˜ˆì‹œ: ê²°ë¡  ë¨¼ì € â†’ ê·¼ê±° 2~3ê°œ â†’ ê°„ë‹¨ ì‚¬ë¡€ â†’ ìš”ì•½`;
    }
    function makeSeedFollowups(q){
      return [
        { q: 'í˜„ì¥ì—ì„œ ì ìš©í•œ ì‹¤ì œ ì‚¬ë¡€ë¥¼ 1ê°€ì§€ ë§í•´ë³´ì„¸ìš”.', a: 'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ êµ¬ì¡°í™”í•˜ì—¬ ê°„ë‹¨íˆ ì„¤ëª…í•©ë‹ˆë‹¤.' },
        { q: 'ê´€ë ¨ ë²•/ì§€ì¹¨ ë˜ëŠ” ìœ¤ë¦¬ ê¸°ì¤€ì€ ë¬´ì—‡ì´ ìˆë‚˜ìš”?', a: 'í•µì‹¬ ì¡°í•­ ëª…ì‹œ í›„, ì§ˆë¬¸ ì£¼ì œì™€ ì—°ê²° ì´ìœ ë¥¼ 1~2ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬.' },
        { q: 'ì´ ì£¼ì œì˜ í•œê³„ë‚˜ ë…¼ë€ ì§€ì ì€? ë³´ì™„ì±…ì€?', a: 'ì˜ˆì‚°/ì¸ë ¥/í˜„ì¥ì—¬ê±´ ë“± ì œì•½ê³¼ ëŒ€ì•ˆì„ ì œì‹œ.' }
      ];
    }
    async function seedAllAugmentationsThenPersist(){
      let changed=false;
      const bank = new Map((await loadShared()).map(q=>[qKey(q), q]));
      for(const q of raw){
        let entry = bank.get(qKey(q));
        if(!entry){
          entry = { subject:q.subject, question:q.question, answers:(q.answers||[]), active:(q.active||0), extraInfo:q.extraInfo||'', followups:q.followups||[] };
        }
        if(!entry.extraInfo){ entry.extraInfo = makeSeedExtraInfo(q); changed=true; }
        if(!Array.isArray(entry.followups) || entry.followups.length===0){ entry.followups = makeSeedFollowups(q); changed=true; }
        q.extraInfo = entry.extraInfo;
        q.followups = entry.followups.slice();
        if(changed){ await persistQuestion(q); changed=false; }
      }
    }

    /* ================= ì‚¬ìš©ì í•„í„°/ì¹´ìš´íŠ¸ ================= */
    async function applyLearnedFilterForCurrentUser(){
      const p = await loadProgress();
      const learned = currentUser ? new Set((p[currentUser]?.learnedIds)||[]) : new Set();
      data = raw.filter(q=> !learned.has(qKey(q))).map(q=>({...q}));
    }

    async function updateCounts(){
      const subj = currentSubject();
      const p = await loadProgress();
      const learnedIds = new Set((p[currentUser]?.learnedIds || []));

      const subjectAll = raw.filter(q => normSubj(q.subject) === subj);
      const subjectTotal = subjectAll.length;

      const subjectLearned = subjectAll.reduce((acc,q)=>{
        return acc + (learnedIds.has(`${normSubj(q.subject)}::${q.question}`) ? 1 : 0);
      }, 0);

      document.getElementById('countTotal').textContent   = `ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ ${subjectTotal}`;
      document.getElementById('countLearned').textContent = `ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ ${subjectLearned}`;
    }

    /* ================= ê³¼ëª©/ë¦¬ìŠ¤íŠ¸ ================= */
    function subjects(){ return Array.from(new Set(raw.map(x=>normSubj(x.subject)))).sort(); }
    function initSubjectSelect(){
      const sel=document.getElementById('subjectSelect');
      const subs=subjects();
      sel.innerHTML=subs.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
      if(subs.length) sel.value=subs[0]; else sel.value='';
      sel.onchange = ()=>{ renderBySubject(currentSubject()); updateCounts(); };
      renderBySubject(currentSubject());
      updateCounts();
    }
    function currentSubject(){ const sel=document.getElementById('subjectSelect'); return sel&&sel.value?sel.value:(subjects()[0]||'ê¸°íƒ€'); }
    function renderBySubject(subj){
      const grid=document.getElementById('grid');

      if(!raw || raw.length===0){
        grid.innerHTML = `<div style="padding:12px;opacity:.7">ë¬¸í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (youth_quiz_data.jsonì„ í™•ì¸)</div>`;
        return;
      }

      const list=data.filter(x=>normSubj(x.subject)===subj)
        .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})" title="${esc(q.question)}">${esc(q.question)}</button>`).join('');

      if(list){
        grid.innerHTML=list;
      }else{
        const totalSubjCount = raw.filter(x=>normSubj(x.subject)===subj).length;
        grid.innerHTML = `<div style="padding:12px;opacity:.7">
          ì´ ê³¼ëª©ì˜ ë¯¸ìŠµë“ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.${totalSubjCount? ' (ëª¨ë“  ë¬¸í•­ì„ ìŠµë“í–ˆìŠµë‹ˆë‹¤)': ''}
        </div>`;
      }
    }

    /* ================= ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ì´ˆê¸°í™” ================= */
    document.getElementById('loginBtn').onclick = async ()=>{
      try{
        const name=(document.getElementById('username').value||'').trim();
        const pass=(document.getElementById('password').value||'');
        if(!name||!pass){ alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        currentUser=name;

        document.getElementById('loginPanel').style.display='none';
        document.getElementById('mainPanel').style.display='block';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('grid').innerHTML = '<div style="opacity:.7;padding:12px">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

        try{
          const all = await loadProgress();
          if(!all[currentUser]){ await saveProgressForUser(currentUser, []); }
        }catch(e){ console.warn('[login] progress ì¤€ë¹„ ì‹¤íŒ¨(ë¬´ì‹œ)', e); }

        await quickRenderBase();
        await bootstrap();
        await renderRanks(); await updateHeaderUser();
      }catch(err){
        console.error('[login] ì¹˜ëª…ì  ì˜¤ë¥˜', err);
        alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
    };

    document.getElementById('logoutBtn').onclick = async ()=>{
      currentUser=null;
      document.getElementById('mainPanel').style.display='none';
      document.getElementById('loginPanel').style.display='block';
      document.getElementById('logoutBtn').style.display='none';
      await renderRanks(); await updateHeaderUser();
      pingFirestore();
    };

    document.getElementById('resetProgress').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      await saveProgressForUser(currentUser, []);
      await applyLearnedFilterForCurrentUser();
      renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    };

    /* ================= ë¹ ë¥¸ 1ë‹¨ê³„ ë Œë” ================= */
    async function quickRenderBase(){
      const base = await loadBase();
      const std  = standardize(base);
      raw = std.map((q,i)=>({...q,_idx:i}));
      await applyLearnedFilterForCurrentUser();

      initSubjectSelect();
      const sel = document.getElementById('subjectSelect');
      if(sel && !sel.value){
        const subs = subjects();
        if(subs.length) sel.value = subs[0];
      }

      renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    /* ================= ì§ˆë¬¸ ëª¨ë‹¬ ================= */
    function openQuestion(idx){
      currentIdx=idx;
      const q=raw.find(x=>x._idx===idx); if(!q) return;
      document.getElementById('qTitle').textContent=q.question;
      document.getElementById('userAnswer').textContent='';
      document.getElementById('result').innerHTML='';
      renderAnswerList();
      document.getElementById('extraInfo').value=q.extraInfo||'';
      renderFollowups();
      document.getElementById('qd').showModal();
      speak(q.question);
    }
    function closeQuestion(){ if(recognition){ recognition.stop(); recognition=null; } document.getElementById('qd').close(); }
    window.openQuestion = openQuestion;
    document.getElementById('closeBtn').onclick = closeQuestion;

    /* ================= ìŒì„± í•©ì„±/ì¸ì‹ ================= */
    function speak(txt){ const u=new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
    document.getElementById('speakBtn').onclick = ()=>{ const q=raw.find(x=>x._idx===currentIdx); if(q) speak(q.question); };
    function startRecognition(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      recognition=new SpeechRecognition();
      recognition.lang='ko-KR'; recognition.continuous=true; recognition.interimResults=true;
      let finalTranscript='';
      recognition.onresult=(event)=>{
        let interim='';
        for(let i=event.resultIndex;i<event.results.length;i++){
          const t=event.results[i][0].transcript;
          if(event.results[i].isFinal){ finalTranscript += t + ' '; } else { interim += t; }
        }
        document.getElementById('userAnswer').textContent=(finalTranscript+interim).trim();
      };
      recognition.start();
    }
    document.getElementById('recordBtn').onclick = ()=>{
      document.getElementById('userAnswer').textContent='(ë…¹ìŒì¤‘...)';
      startRecognition();
    };

    /* ================= ìœ ì‚¬ë„ & ë‹µë³€ì™„ë£Œ ================= */
    function similarity(a,b){
      const sa=new Set(String(a).split(/\s+/).filter(Boolean));
      const sb=new Set(String(b).split(/\s+/).filter(Boolean));
      let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
      return inter/(sa.size+sb.size-inter||1);
    }
    document.getElementById('submitBtn').onclick = ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      const goldRaw=(q.answers&&q.answers.length)? (q.answers[q.active||0]||q.answers[0]) : '';
      const gold=stripAuthorTag(goldRaw); // íƒœê·¸ ì œê±° í›„ ë¹„êµ
      const user=document.getElementById('userAnswer').textContent;
      const sim=similarity(user,gold);
      document.getElementById('result').innerHTML = `<div class='answer-box'>${esc(goldRaw)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;

      // ë‹µë³€ì™„ë£Œ ì‹œ ë…¹ìŒ/í‘œì‹œ ê¸°ëŠ¥ ì¢…ë£Œ
      stopRecognition();
      try{ speechSynthesis.cancel(); }catch{}
    };

    /* ================= ìŠµë“ì™„ë£Œ ================= */
    document.getElementById('learnedBtn').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const q = raw.find(x=>x._idx===currentIdx); if(!q) return;
      const id = qKey(q);

      data = data.filter(item => qKey(item) !== id);
      renderBySubject(currentSubject());
      closeQuestion();

      try{
        const all = await loadProgress();
        const mine = new Set((all[currentUser]?.learnedIds || []));
        mine.add(id);
        await saveProgressForUser(currentUser, Array.from(mine));
      }catch(e){ console.warn('[learned] ì €ì¥ ì‹¤íŒ¨ â€“ ë¡œì»¬ ìœ ì§€', e); }

      try{
        await updateCounts();
        await updateHeaderUser();
        await renderRanks();
      }catch(e){}
    };

    /* ================= ì •ë‹µ/ì„¤ëª…/ì¶”ê°€ì§ˆë¬¸ ê´€ë¦¬ ================= */
    function renderAnswerList(){
      const holder=document.getElementById('extraAnswers');
      const q=raw.find(x=>x._idx===currentIdx); if(!q){ holder.innerHTML=''; return; }

      const items=(q.answers||[]).map((ans,i)=>{
        const author = getAuthorFromAnswer(ans);
        const checked=(q.active||0)===i?'checked':'';
        const mine = !!currentUser && author === currentUser;
        return `<div style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
          <input type="radio" name="ansPick" value="${i}" ${checked} style="margin-top:4px"/>
          <div style="flex:1;white-space:pre-wrap">${esc(ans)}</div>
          ${ mine
            ? `<button class="btn" data-edit-ans="${i}">âœï¸ í¸ì§‘</button>
               <button class="btn danger" data-del-ans="${i}">ğŸ—‘ ì‚­ì œ</button>`
            : `<div class="pill" title="ì‘ì„±ìë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥">ì‘ì„±ì: ${esc(author)}</div>`
          }
        </div>`;
      }).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';

      holder.innerHTML = `<h3 style="margin:10px 0 6px">ì •ë‹µ ëª©ë¡</h3>` + items;

      holder.querySelectorAll('input[name="ansPick"]').forEach(r=>{
        r.addEventListener('change', async (e)=>{
          q.active = parseInt(e.target.value,10)||0;
          await persistQuestion(q);
        });
      });
      holder.querySelectorAll('[data-edit-ans]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-edit-ans'),10);
          const ans = q.answers[i];
          const author = getAuthorFromAnswer(ans);
          if(!currentUser || author!==currentUser){ alert('ì‘ì„±ìë§Œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
          const baseText = stripAuthorTag(ans);
          const val = prompt('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ) í¸ì§‘', baseText);
          if(val===null) return;
          q.answers[i] = ensureTagged(val.trim(), currentUser);
          await persistQuestion(q);
          renderAnswerList();
        });
      });
      holder.querySelectorAll('[data-del-ans]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-ans'),10);
          const ans = q.answers[i];
          const author = getAuthorFromAnswer(ans);
          if(!currentUser || author!==currentUser){ alert('ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
          q.answers.splice(i,1);
          if((q.active||0)>=q.answers.length) q.active=Math.max(0,q.answers.length-1);
          await persistQuestion(q);
          renderAnswerList();
        });
      });
    }
    document.getElementById('addAnswerBtn').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
      q.answers=q.answers||[];
      const withTag = ensureTagged(val.trim(), currentUser);
      if(!q.answers.includes(withTag)){
        q.answers.push(withTag);
        q.active=q.answers.length-1;
        await persistQuestion(q);
      }
      renderAnswerList();
    };
    document.getElementById('saveExtraInfoBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      q.extraInfo=(document.getElementById('extraInfo').value||'').trim();
      await persistQuestion(q);
      alert('ì¶”ê°€ì„¤ëª…ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
    };
    (function(){
      const btn = document.getElementById('expandExtraInfoBtn');
      let expanded=false;
      btn.addEventListener('click', ()=>{
        const ta=document.getElementById('extraInfo');
        expanded=!expanded;
        if(expanded){ ta.style.maxHeight='80vh'; ta.style.minHeight='60vh'; btn.textContent='ğŸ” ì ‘ê¸°'; }
        else { ta.style.maxHeight='50vh'; ta.style.minHeight='80px'; btn.textContent='ğŸ” ì „ì²´ë³´ê¸°'; }
      });
    })();
    function renderFollowups(){
      const box=document.getElementById('followupsBox');
      const q=raw.find(x=>x._idx===currentIdx); if(!q){ box.innerHTML=''; return; }
      const items=(q.followups||[]).map((f,i)=>`<div style="display:flex;gap:8px;flex-direction:column;border:1px solid #1f2a55;border-radius:10px;padding:8px;margin:6px 0">
          <div><b>Q${i+1}.</b> ${esc(f.q)}</div>
          <div><b>A${i+1}.</b> ${esc(f.a)}</div>
          <div><button class='btn danger' data-del-fu='${i}'>ğŸ—‘ ì‚­ì œ</button></div>
        </div>`).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì¶”ê°€ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      box.innerHTML=items;
      box.querySelectorAll('[data-del-fu]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-fu'),10);
          q.followups.splice(i,1);
          await persistQuestion(q);
          renderFollowups();
        });
      });
    }
    document.getElementById('addFollowupBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      const fq=(document.getElementById('fuQ').value||'').trim();
      const fa=(document.getElementById('fuA').value||'').trim();
      if(!fq||!fa){ alert('ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      q.followups=q.followups||[]; q.followups.push({q:fq,a:fa});
      document.getElementById('fuQ').value=''; document.getElementById('fuA').value='';
      await persistQuestion(q);
      renderFollowups();
    };

    /* ================= ì§ˆë¬¸ ì¶”ê°€/ì‚­ì œ(ê³µìœ ) ================= */
    document.getElementById('addQuestionBtn').onclick = async ()=>{
      const subj=prompt('ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!subj) return;
      const ques=prompt('ìƒˆ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!ques) return;
      const answ=prompt('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!answ) return;
      const id = `${normSubj(subj)}::${ques}`;
      if(raw.some(x=> qKey(x)===id)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸í•­ì…ë‹ˆë‹¤.'); return; }
      const seed = {
        subject:normSubj(subj), question:ques,
        answers:[ensureTagged(answ, 'ê´€ë¦¬ì')], active:0,
        extraInfo: makeSeedExtraInfo({subject:subj,question:ques}),
        followups: makeSeedFollowups({subject:subj,question:ques})
      };
      const current = await loadShared();
      current.push(seed);
      await saveShared(current);
      await bootstrap();
    };
    document.getElementById('deleteQuestionBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      if(!confirm('ì´ ì§ˆë¬¸ì„ ëª¨ë“  ì‚¬ìš©ìì—ê²Œì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await deleteSharedQuestion(q);
      await bootstrap();
    };

    /* ================= ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ================= */
    (function(){
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');

      function download(filename, text){
        const blob = new Blob([text], {type: 'application/json;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        URL.revokeObjectURL(url); a.remove();
      }

      async function exportAll(){
        const shared = await loadShared();
        const progress = await loadProgress();
        const payload = { version: 2, exportedAt: new Date().toISOString(), shared, progress };
        download('youth-interview-backup.json', JSON.stringify(payload,null,2));
        alert('ë‚´ë³´ë‚´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      async function importAll(file){
        try{
          const text = await file.text();
          const obj = JSON.parse(text);
          if(typeof obj !== 'object' || obj === null) throw new Error('JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
          if(!('shared' in obj) || !('progress' in obj)) throw new Error('shared/progress í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
          if(!Array.isArray(obj.shared)) throw new Error('sharedëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          if(typeof obj.progress !== 'object') throw new Error('progressëŠ” ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
          if(!confirm('í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì“°ê¸°/ë³‘í•©ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;

          // shared ë‚´ answersë„ íƒœê·¸ ë³´ì •
          obj.shared = obj.shared.map(rec=>{
            const copy = {...rec};
            copy.answers = (copy.answers||[]).map(a=>ensureTagged(a,'ê´€ë¦¬ì'));
            return copy;
          });

          await saveShared(obj.shared);

          // âœ… ê´€ë¦¬ì í¬í•¨í•´ì„œ ëª¨ë‘ ë°˜ì˜
          const names = Object.keys(obj.progress||{});
          for(const name of names){
            const learned = Array.from(new Set((obj.progress[name]?.learnedIds)||[]));
            await saveProgressForUser(name, learned);
          }

          await bootstrap();
          alert('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          console.error(e);
          alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message||e));
        }
      }

      if(exportBtn) exportBtn.addEventListener('click', exportAll);
      if(importBtn && importFile){
        importBtn.addEventListener('click', ()=> importFile.click());
        importFile.addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if(f) importAll(f);
          e.target.value = '';
        });
      }
    })();

    /* ================= ë¶€íŠ¸ìŠ¤íŠ¸ë© ================= */
    async function bootstrap(){
      const base=await loadBase();
      const std = standardize(base);
      await mergeWithShared(std);

      // ì•ˆì „ë§: ëª¨ë“  ì •ë‹µ ë¬¸ìì—´ì— íƒœê·¸ ë³´ì¥
      raw.forEach(q=>{
        q.answers = (q.answers||[]).map(a => ensureTagged(a, 'ê´€ë¦¬ì'));
      });

      await applyLearnedFilterForCurrentUser();
      initSubjectSelect();
      renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    // ì´ˆê¸°: ìˆœìœ„ ë¨¼ì €
    renderRanks();
  </script>
</body>
</html>
