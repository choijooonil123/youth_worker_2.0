<!doctype html>
<html lang="ko">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
Â  <style>
Â  Â  :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; --yellow-text: #ffd700; }
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
Â  Â  header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
Â  Â  .spacer{flex:1}
Â  Â  header h1{margin:0;font-size:18px}
Â  Â  .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

Â  Â  .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
Â  Â  .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
Â  Â  .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
Â  Â  .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
Â  Â  .toolbar .btn:hover{background:#1a2a56}
Â  Â  .toolbar .stat{color:var(--muted);font-size:13px}
Â  Â  .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
Â  Â  .counts{display:flex;gap:12px;align-items:center}
Â  Â  .counts .pill{border-color:#2b3769}

Â  Â  /* ì§ˆë¬¸ ë²„íŠ¼ ê°„ê²©(ì¢ê²Œ) */
Â  Â  .grid{display:grid;gap:6px;padding:10px;grid-template-columns:1fr}
Â  Â  .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:8px 10px;margin:2px 0;cursor:pointer;font-size:14px;line-height:1.28}
Â  Â  .qbtn:hover{background:#121b3e}

Â  Â  dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
Â  Â  dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
Â  Â  .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
Â  Â  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
Â  Â  .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
Â  Â  .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
Â  Â  .btn.ok{background:#123b2a;border-color:#0d5b3a}
Â  Â  .btn.danger{background:#3a1330;border-color:#7a244f}
Â  Â  .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap;font-size:14px}
Â  Â  textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px;font-size:14px}

Â  Â  /* ë¡œê·¸ì¸ ë°•ìŠ¤ ì»´íŒ©íŠ¸ */
Â  Â  .login-card{width:min(420px,92vw);margin:0 auto}

Â  Â  /* ê¸´ ì¶”ê°€ì„¤ëª… ë³´ê¸° */
Â  Â  #extraInfo { max-height:50vh; overflow:auto; resize:vertical; }

Â  Â  .score{font-size:36px;font-weight:800}

Â  Â  /* ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ */
Â  Â  #qTitle { color: var(--yellow-text); }
Â  Â  .followup-q { color: var(--yellow-text); }
Â  Â  .answer-controls { display: flex; align-items: center; justify-content: space-between; margin: 10px 0 6px; }
Â  Â  .answer-list-item { display: flex; gap: 8px; align-items: flex-start; margin: 6px 0; }
Â  </style>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
Â  Â  import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

Â  Â  /* ğŸ”‘ Firebase ì½˜ì†” ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš” */
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyB8uvt7bkZokVkHT7nO0QRaB9WpEe2g2C4",
Â  Â  Â  authDomain: "youth-worker.firebaseapp.com",
Â  Â  Â  projectId: "youth-worker",
Â  Â  Â  storageBucket: "youth-worker.appspot.com", /* â† appspot.com í˜•íƒœ */
Â  Â  Â  messagingSenderId: "666890915384",
Â  Â  Â  appId: "1:666890915384:web:2dbc2b4d35aa9e3948a0cd",
Â  Â  Â  measurementId: "G-GT3X3E9VTB"
Â  Â  };

Â  Â  try{
Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  const dbÂ  = getFirestore(app);
Â  Â  Â  window.__cloudReady = true;
Â  Â  Â  window.__fb = {
Â  Â  Â  Â  db,
Â  Â  Â  Â  colShared : () => collection(db, "sharedData"),
Â  Â  Â  Â  colProgress: () => collection(db, "progress")
Â  Â  Â  };
Â  Â  Â  window.__fb_api = { getDoc, getDocs, setDoc, doc, deleteDoc, writeBatch };
Â  Â  Â  console.log('[firebase] initialized');
Â  Â  }catch(e){
Â  Â  Â  console.warn('[firebase] init failed -> fallback to local only', e);
Â  Â  Â  window.__cloudReady = false;
Â  Â  }
Â  </script>

Â  Â  <script>
Â  Â  window.__cloudReady = window.__cloudReady || false;
Â  Â  window.__fbÂ  Â  Â  Â = window.__fbÂ  Â  Â  Â || { db:null, colShared:()=>({}), colProgress:()=>({}) };
Â  Â  window.__fb_apiÂ  Â = window.__fb_apiÂ  Â || {};
Â  Â  window.__fb_api.getDocsÂ  Â = window.__fb_api.getDocsÂ  Â || (async ()=>({ forEach:()=>{} }));
Â  Â  window.__fb_api.setDocÂ  Â  = window.__fb_api.setDocÂ  Â  || (async ()=>{});
Â  Â  window.__fb_api.docÂ  Â  Â  Â = window.__fb_api.docÂ  Â  Â  Â || (/*noop*/()=>({}));
Â  Â  window.__fb_api.deleteDoc = window.__fb_api.deleteDoc || (async ()=>{});
Â  Â  window.__fb_api.writeBatch= window.__fb_api.writeBatch|| (/*noop*/()=>({ set(){}, commit:async()=>{} }));
Â  </script>
</head>
<body>
Â  <header>
Â  Â  <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
Â  Â  <h1>í•™ìŠµì‹œìŠ¤í…œ</h1>
Â  Â  <div class="spacer"></div>
Â  Â  <div id="headerRank" class="pill" style="display:none"></div>
Â  Â  <div id="headerUser" class="pill" style="display:none"></div>
Â  Â  <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
Â  </header>

Â  <div class="wrap">
Â  Â  Â  Â  <div id="loginPanel" class="panel">
Â  Â  Â  <div class="login-card" style="padding:20px;display:flex;flex-direction:column;gap:12px">
Â  Â  Â  Â  <h2>ë¡œê·¸ì¸</h2>
Â  Â  Â  Â  <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
Â  Â  Â  Â  <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
Â  Â  Â  Â  <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸</button>
Â  Â  Â  Â  <div id="envErr" style="font-size:12px;color:#ffb3b3;min-height:18px"></div>
Â  Â  Â  Â  <div id="rankList" style="margin-top:10px"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="mainPanel" class="panel" style="display:none">
Â  Â  Â  <div class="toolbar">
Â  Â  Â  Â  <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
Â  Â  Â  Â  <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
Â  Â  Â  Â  <select id="subjectSelect"></select>
Â  Â  Â  Â  <div class="counts">
Â  Â  Â  Â  Â  <div class="pill" id="countTotal">ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ 0</div>
Â  Â  Â  Â  Â  <div class="pill" id="countLearned">ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ 0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
Â  Â  Â  Â  Â  <button id="addQuestionBtn" class="btn">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</button>
Â  Â  Â  Â  Â  <button id="exportBtn" class="btn">ë‚´ë³´ë‚´ê¸°</button>
Â  Â  Â  Â  Â  <button id="importBtn" class="btn">ê°€ì ¸ì˜¤ê¸°</button>
Â  Â  Â  Â  Â  <input id="importFile" type="file" accept="application/json" style="display:none">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div id="grid" class="grid"></div>
Â  Â  </div>
Â  </div>

Â  Â  <dialog id="qd">
Â  Â  <div class="dlg">
Â  Â  Â  <h2 id="qTitle">ì§ˆë¬¸</h2>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
Â  Â  Â  Â  <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
Â  Â  Â  Â  <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
Â  Â  Â  Â  <button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button>
Â  Â  Â  Â  <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
Â  Â  Â  Â  <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
Â  Â  Â  </div>
Â  Â  Â  <div><div class="answer-box" id="userAnswer"></div></div>
Â  Â  Â  <div id="result"></div>
Â  Â  Â  <div id="extraAnswers"></div>

Â  Â  Â  <hr style="border:0;border-top:1px solid #1f2a55;margin:8px 0">
Â  Â  Â  <div>
Â  Â  Â  Â  <h3>ì¶”ê°€ì„¤ëª…</h3>
Â  Â  Â  Â  <textarea id="extraInfo" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
Â  Â  Â  Â  <button id="saveExtraInfoBtn" class="btn">ğŸ’¾ ì¶”ê°€ì„¤ëª… ì €ì¥</button>
Â  Â  Â  Â  <button id="speakExtraInfoBtn" class="btn">ğŸ”Š ì¶”ê°€ì„¤ëª… ë“£ê¸°</button>
Â  Â  Â  Â  <button id="expandExtraInfoBtn" class="btn">ğŸ” ì „ì²´ë³´ê¸°</button>
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
Â  Â  Â  Â  <div id="followupsBox" class="answer-box" style="min-height:0"></div>
Â  Â  Â  Â  <div class="row" style="align-items:flex-start">
Â  Â  Â  Â  Â  <textarea id="fuQ" rows="3" placeholder="ì¶”ê°€ì§ˆë¬¸"></textarea>
Â  Â  Â  Â  Â  <textarea id="fuA" rows="3" placeholder="ì¶”ê°€ë‹µë³€"></textarea>
Â  Â  Â  Â  Â  <button id="addFollowupBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì¶”ê°€</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </dialog>

Â  <script>
Â  Â  /* ================= ê³µí†µ ìƒíƒœ/ìœ í‹¸ ================= */
Â  Â  let raw = [];Â  Â  Â  Â  // ì „ì²´ ë¬¸í•­(ê³µìœ )
Â  Â  let data = [];Â  Â  Â  Â // ë¯¸ìŠµë“ë§Œ í‘œì‹œ
Â  Â  let currentUser = null;
Â  Â  let currentIdx = null;
Â  Â  let recognition = null;

Â  Â  const LS_SHARED = 'yj_shared_backup_v1';
Â  Â  const LS_PROGÂ  Â = 'yj_progress_backup_v1';

Â  Â  const normSubj = s => (s && String(s).trim()) ? String(s).trim() : 'ê¸°íƒ€';
Â  Â  const esc = s => String(s).replace(/[&<>"']/g, m => ({
Â  Â  Â  "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;"
Â  Â  }[m]));
Â  Â  const qKey = q => `${normSubj(q.subject)}::${q.question}`;

Â  Â  /* ================= ë¡œì»¬ í´ë°± ì €ì¥ì†Œ ================= */
Â  Â  function lsGet(key, def){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v): def; }catch{return def;} }
Â  Â  function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

Â  Â  /* ================= Firestore ì§„ë‹¨ (ì¡°ìš© ëª¨ë“œ) ================= */
Â  Â  async function pingFirestore(){
Â  Â  Â  const box = document.getElementById('envErr');
Â  Â  Â  try{
Â  Â  Â  Â  if(!window.__cloudReady){ box.textContent=''; return false; }
Â  Â  Â  Â  const { getDocs } = window.__fb_api;
Â  Â  Â  Â  await getDocs(window.__fb.colShared());
Â  Â  Â  Â  box.textContent = '';
Â  Â  Â  Â  return true;
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.warn('[pingFirestore] Firestore unavailable (silent):', e?.code, e?.message);
Â  Â  Â  Â  box.textContent = ''; // í™”ë©´ì— ì˜¤ë¥˜ í‘œì‹œ ì•ˆ í•¨
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  }
Â  Â  document.addEventListener('DOMContentLoaded', ()=>{ pingFirestore(); });

Â  Â  /* ================= ë°ì´í„° ë¡œë“œ/ì €ì¥ (Cloud-First) ================= */
Â  Â  async function loadShared(){
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { getDocs } = window.__fb_api;
Â  Â  Â  Â  Â  const snap = await getDocs(window.__fb.colShared());
Â  Â  Â  Â  Â  const arr = [];
Â  Â  Â  Â  Â  snap.forEach(d => arr.push(d.data()));
Â  Â  Â  Â  Â  lsSet(LS_SHARED, arr); // ë¡œì»¬ ë°±ì—…
Â  Â  Â  Â  Â  return arr;
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[loadShared] cloud fail -> local fallback', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return lsGet(LS_SHARED, []);
Â  Â  }
Â  Â  async function saveShared(array){
Â  Â  Â  lsSet(LS_SHARED, array); // ë¡œì»¬ í•­ìƒ ìœ ì§€
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { writeBatch, doc } = window.__fb_api;
Â  Â  Â  Â  Â  const db = window.__fb.db;
Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  array.forEach(rec=>{
Â  Â  Â  Â  Â  Â  const id = `${normSubj(rec.subject)}::${rec.question}`;
Â  Â  Â  Â  Â  Â  batch.set(doc(db, "sharedData", id), rec, { merge:true });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[saveShared] cloud fail (local kept)', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  async function persistQuestion(q){
Â  Â  Â  const local = lsGet(LS_SHARED, []);
Â  Â  Â  const id = qKey(q);
Â  Â  Â  const rec = { subject:q.subject, question:q.question, answers:q.answers||[], active:q.active||0, extraInfo:q.extraInfo||'', followups:q.followups||[] };
Â  Â  Â  const i = local.findIndex(x=>`${normSubj(x.subject)}::${x.question}`===id);
Â  Â  Â  if(i>=0) local[i]=rec; else local.push(rec);
Â  Â  Â  lsSet(LS_SHARED, local);
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { setDoc, doc } = window.__fb_api;
Â  Â  Â  Â  Â  const db = window.__fb.db;
Â  Â  Â  Â  Â  await setDoc(doc(db,"sharedData",id), rec, { merge:true });
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[persistQuestion] cloud fail (local kept)', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  async function deleteSharedQuestion(q){
Â  Â  Â  const id = qKey(q);
Â  Â  Â  const local = lsGet(LS_SHARED, []);
Â  Â  Â  lsSet(LS_SHARED, local.filter(x=>`${normSubj(x.subject)}::${x.question}`!==id));
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { deleteDoc, doc } = window.__fb_api;
Â  Â  Â  Â  Â  const db = window.__fb.db;
Â  Â  Â  Â  Â  await deleteDoc(doc(db, "sharedData", id));
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[deleteSharedQuestion] cloud fail (local kept)', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  async function loadProgress(){
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { getDocs } = window.__fb_api;
Â  Â  Â  Â  Â  const snap = await getDocs(window.__fb.colProgress());
Â  Â  Â  Â  Â  const obj = {};
Â  Â  Â  Â  Â  snap.forEach(d => { obj[d.id] = d.data(); });
Â  Â  Â  Â  Â  lsSet(LS_PROG, obj);
Â  Â  Â  Â  Â  return obj;
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[loadProgress] cloud fail -> local fallback', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return lsGet(LS_PROG, {});
Â  Â  }
Â  Â  async function saveProgressForUser(username, learnedIds){
Â  Â  Â  const local = lsGet(LS_PROG, {});
Â  Â  Â  local[username] = { learnedIds: Array.from(new Set(learnedIds)) };
Â  Â  Â  lsSet(LS_PROG, local);
Â  Â  Â  if(window.__cloudReady){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const { setDoc, doc } = window.__fb_api;
Â  Â  Â  Â  Â  const db = window.__fb.db;
Â  Â  Â  Â  Â  await setDoc(doc(db, "progress", username), local[username], { merge:true });
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('[saveProgressForUser] cloud fail (local kept)', e);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  /* ================= ìˆœìœ„/í—¤ë” ================= */
Â  Â  async function renderRanks(){
Â  Â  Â  const progress = await loadProgress();
Â  Â  Â  const total = raw.length || 1; // ì „ì²´ ë¬¸ì œ ìˆ˜
Â  Â  Â  const EXCLUDE = new Set(['admin','ê´€ë¦¬ì']); // ê´€ë¦¬ì ì œì™¸

Â  Â  Â  const rows = Object.keys(progress)
Â  Â  Â  Â  .filter(u => !EXCLUDE.has(u))
Â  Â  Â  Â  .map(u=>{
Â  Â  Â  Â  Â  const learned = (progress[u]?.learnedIds || []).length;
Â  Â  Â  Â  Â  const rate = ((learned / total) * 100).toFixed(1);
Â  Â  Â  Â  Â  return { u, learned, rate };
Â  Â  Â  Â  })
Â  Â  Â  Â  .sort((a,b)=> b.learned - a.learned);

Â  Â  Â  const html = '<h3>í•™ìŠµì ìˆœìœ„</h3>' + (
Â  Â  Â  Â  rows.length
Â  Â  Â  Â  Â  ? rows.map((r,i)=>`<div>${i+1}ìœ„ ${esc(r.u)} â€” ìŠµë“ìˆ˜: ${r.learned}, ìŠµë“ìœ¨: ${r.rate}%</div>`).join('')
Â  Â  Â  Â  Â  : '<div style="opacity:.7">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
Â  Â  Â  );
Â  Â  Â  document.getElementById('rankList').innerHTML = html;
Â  Â  }
Â  Â  async function updateHeaderUser(){
Â  Â  Â  const rankEl = document.getElementById('headerRank');
Â  Â  Â  const userEl = document.getElementById('headerUser');
Â  Â  Â  const loÂ  Â  Â = document.getElementById('logoutBtn');

Â  Â  Â  if(!currentUser){
Â  Â  Â  Â  rankEl.style.display='none'; userEl.style.display='none'; lo.style.display='none';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const progress = await loadProgress();
Â  Â  Â  const myLearned = (progress[currentUser]?.learnedIds || []).length;
Â  Â  Â  const total = raw.length || 1;
Â  Â  Â  const rate = ((myLearned / total) * 100).toFixed(1);

Â  Â  Â  const rows = Object.keys(progress).map(u=>({ u, c:(progress[u]?.learnedIds||[]).length }))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a,b)=> b.c - a.c);
Â  Â  Â  const idx = rows.findIndex(r=> r.u === currentUser);

Â  Â  Â  rankEl.textContent = `ì´ë¬¸ì œìˆ˜: ${total} Â· ìŠµë“ìˆ˜: ${myLearned} Â· ìŠµë“ìœ¨: ${rate}% Â· ìˆœìœ„: ${idx>=0? (idx+1)+'ìœ„':'-'}`;
Â  Â  Â  userEl.textContent = `ì‚¬ìš©ì: ${currentUser}`;

Â  Â  Â  rankEl.style.display='inline-block';
Â  Â  Â  userEl.style.display='inline-block';
Â  Â  Â  lo.style.displayÂ  Â  = 'inline-block';
Â  Â  }

Â  Â  /* ================= ë² ì´ìŠ¤ ë°ì´í„° ================= */
Â  Â  const FALLBACK = [
Â  Â  Â  { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?', answers:['ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ í˜•ì„±'], active:0, extraInfo:'ì‹ ë¢° í˜•ì„±ì„ ìœ„í•´ ìƒë‹´ìì˜ ì§„ì •ì„±Â·ê³µê°Â·ë¬´ì¡°ê±´ì  ì¡´ì¤‘ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.', followups:[{q:'í˜„ì¥ì—ì„œ ì ìš© ì‚¬ë¡€?',a:'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ ê°„ë‹¨íˆ ì„¤ëª….'}] },
Â  Â  Â  { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?', answers:['ë³´í˜¸, ì°¸ì—¬, ë°œë‹¬'], active:0, extraInfo:'ë³´í˜¸(ìœ„í—˜Â·ê¶Œë¦¬ì¹¨í•´ë¡œë¶€í„° ë³´í˜¸), ì°¸ì—¬(ì˜ì‚¬ê²°ì • ì°¸ì—¬), ë°œë‹¬(ê±´ê°•í•œ ì„±ì¥ ì§€ì›).', followups:[{q:'ê° ì¶•ì˜ ëŒ€í‘œì‚¬ì—…?',a:'ë³´í˜¸: ìœ„ê¸°ì²­ì†Œë…„ ì§€ì› / ì°¸ì—¬: ì²­ì†Œë…„ìš´ì˜ìœ„ / ë°œë‹¬: ì§„ë¡œÂ·ìê¸°ê°œë°œ'}] }
Â  Â  ];
Â  Â  async function loadBase(){
Â  Â  Â  try{
Â  Â  Â  Â  const r=await fetch('youth_quiz_data.json',{cache:'no-store'});
Â  Â  Â  Â  if(!r.ok) throw 0;
Â  Â  Â  Â  const j=await r.json();
Â  Â  Â  Â  return Array.isArray(j)&&j.length? j : FALLBACK;
Â  Â  Â  }catch{ return FALLBACK; }
Â  Â  }
Â  Â  function standardize(base){
Â  Â  Â  return base.map(x=>({
Â  Â  Â  Â  subject: normSubj(x.subject),
Â  Â  Â  Â  question: x.question,
Â  Â  Â  Â  answers: Array.isArray(x.answers)? x.answers.filter(Boolean) : [(x.answer||'')].filter(Boolean),
Â  Â  Â  Â  active: (typeof x.active==='number'? x.active:0),
Â  Â  Â  Â  extraInfo: (typeof x.extraInfo==='string')? x.extraInfo : '',
Â  Â  Â  Â  followups: Array.isArray(x.followups)? x.followups.filter(f=>f&&f.q&&f.a) : []
Â  Â  Â  }));
Â  Â  }
Â  Â  async function mergeWithShared(baseStd){
Â  Â  Â  const map=new Map();
Â  Â  Â  baseStd.forEach(q=> map.set(qKey(q), {...q}) );
Â  Â  Â  const shared = await loadShared();
Â  Â  Â  shared.forEach(q=>{
Â  Â  Â  Â  const id=qKey(q);
Â  Â  Â  Â  if(map.has(id)){
Â  Â  Â  Â  Â  const cur=map.get(id);
Â  Â  Â  Â  Â  cur.answers=[...new Set([...(cur.answers||[]), ...((q.answers||[]).filter(Boolean))])];
Â  Â  Â  Â  Â  if(!cur.extraInfo && q.extraInfo) cur.extraInfo=q.extraInfo;
Â  Â  Â  Â  Â  const fu=Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a) : [];
Â  Â  Â  Â  Â  cur.followups=[...(cur.followups||[]), ...fu];
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  map.set(id,{
Â  Â  Â  Â  Â  Â  subject:normSubj(q.subject),
Â  Â  Â  Â  Â  Â  question:q.question,
Â  Â  Â  Â  Â  Â  answers:(q.answers||[]).filter(Boolean),
Â  Â  Â  Â  Â  Â  active:(q.active||0),
Â  Â  Â  Â  Â  Â  extraInfo:(q.extraInfo||''),
Â  Â  Â  Â  Â  Â  followups:Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[]
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  raw=Array.from(map.values()).map((q,i)=>({...q,_idx:i}));
Â  Â  }

Â  Â  /* ================= ì‚¬ìš©ì í•„í„°/ì¹´ìš´íŠ¸ ================= */
Â  Â  async function applyLearnedFilterForCurrentUser(){
Â  Â  Â  const p = await loadProgress();
Â  Â  Â  const learned = currentUser ? new Set((p[currentUser]?.learnedIds)||[]) : new Set();
Â  Â  Â  data = raw.filter(q=> !learned.has(qKey(q))).map(q=>({...q}));
Â  Â  }

Â  Â  /* â–¶ ê³¼ëª©ë³„ ì¹´ìš´íŠ¸(ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ / ê³¼ëª©ë³„ : ìŠµë“ìˆ˜) */
Â  Â  async function updateCounts(){
Â  Â  Â  const subj = currentSubject();
Â  Â  Â  const p = await loadProgress();
Â  Â  Â  const learnedIds = new Set((p[currentUser]?.learnedIds || []));

Â  Â  Â  const subjectAll = raw.filter(q => normSubj(q.subject) === subj);
Â  Â  Â  const subjectTotal = subjectAll.length;

Â  Â  Â  const subjectLearned = subjectAll.reduce((acc,q)=>{
Â  Â  Â  Â  return acc + (learnedIds.has(`${normSubj(q.subject)}::${q.question}`) ? 1 : 0);
Â  Â  Â  }, 0);

Â  Â  Â  document.getElementById('countTotal').textContentÂ  Â = `ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ ${subjectTotal}`;
Â  Â  Â  document.getElementById('countLearned').textContent = `ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ ${subjectLearned}`;
Â  Â  }

Â  Â  /* ================= ê³¼ëª©/ë¦¬ìŠ¤íŠ¸ ================= */
Â  Â  function subjects(){ return Array.from(new Set(raw.map(x=>normSubj(x.subject)))).sort(); }
Â  Â  function initSubjectSelect(){
Â  Â  Â  const sel=document.getElementById('subjectSelect');
Â  Â  Â  const subs=subjects();
Â  Â  Â  sel.innerHTML=subs.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
Â  Â  Â  if(subs.length) sel.value=subs[0]; else sel.value='';
Â  Â  Â  sel.onchange = ()=>{ renderBySubject(currentSubject()); updateCounts(); };
Â  Â  Â  renderBySubject(currentSubject());
Â  Â  Â  updateCounts();
Â  Â  }
Â  Â  function currentSubject(){ const sel=document.getElementById('subjectSelect'); return sel&&sel.value?sel.value:(subjects()[0]||'ê¸°íƒ€'); }
Â  Â  function renderBySubject(subj){
Â  Â  Â  const grid=document.getElementById('grid');
Â  Â  Â  if(!raw || raw.length===0){
Â  Â  Â  Â  grid.innerHTML = `<div style="padding:12px;opacity:.7">ë¬¸í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (youth_quiz_data.jsonì„ í™•ì¸)</div>`;
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const list=data.filter(x=>normSubj(x.subject)===subj)
Â  Â  Â  Â  .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})" title="${esc(q.question)}">${esc(q.question)}</button>`).join('');
Â  Â  Â  if(list){
Â  Â  Â  Â  grid.innerHTML=list;
Â  Â  Â  }else{
Â  Â  Â  Â  const totalSubjCount = raw.filter(x=>normSubj(x.subject)===subj).length;
Â  Â  Â  Â  grid.innerHTML = `<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë¯¸ìŠµë“ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.${totalSubjCount? ' (ëª¨ë“  ë¬¸í•­ì„ ìŠµë“í–ˆìŠµë‹ˆë‹¤)': ''}</div>`;
Â  Â  Â  }
Â  Â  }

Â  Â  /* ================= ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ì´ˆê¸°í™” ================= */
Â  Â  document.getElementById('loginBtn').onclick = async ()=>{
Â  Â  Â  try{
Â  Â  Â  Â  const name=(document.getElementById('username').value||'').trim();
Â  Â  Â  Â  const pass=(document.getElementById('password').value||'');
Â  Â  Â  Â  if(!name||!pass){ alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
Â  Â  Â  Â  currentUser=name;

Â  Â  Â  Â  // í™”ë©´ ì „í™˜ ë¨¼ì € (ì¦‰ì‹œ í‘œì‹œ)
Â  Â  Â  Â  document.getElementById('loginPanel').style.display='none';
Â  Â  Â  Â  document.getElementById('mainPanel').style.display='block';
Â  Â  Â  Â  document.getElementById('logoutBtn').style.display = 'inline-block';
Â  Â  Â  Â  document.getElementById('grid').innerHTML = '<div style="opacity:.7;padding:12px">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

Â  Â  Â  Â  // ì§„í–‰ë„ ë¬¸ì„œ ë³´ì¥ (ì‹¤íŒ¨í•´ë„ ê³„ì†)
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const all = await loadProgress();
Â  Â  Â  Â  Â  if(!all[currentUser]){ await saveProgressForUser(currentUser, []); }
Â  Â  Â  Â  }catch(e){ console.warn('[login] progress ì¤€ë¹„ ì‹¤íŒ¨(ë¬´ì‹œ)', e); }

Â  Â  Â  Â  await quickRenderBase(); // 1ë‹¨ê³„: ê¸°ë³¸ JSON ì¦‰ì‹œ ë Œë”
Â  Â  Â  Â  await bootstrap();Â  Â  Â  Â // 2ë‹¨ê³„: ê³µìœ ë°ì´í„° ë³‘í•© ìµœì‹ í™”
Â  Â  Â  Â  await renderRanks();
Â  Â  Â  Â  await updateHeaderUser();
Â  Â  Â  }catch(err){
Â  Â  Â  Â  console.error('[login] ì¹˜ëª…ì  ì˜¤ë¥˜', err);
Â  Â  Â  Â  alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
Â  Â  Â  }
Â  Â  };

Â  Â  document.getElementById('logoutBtn').onclick = async ()=>{
Â  Â  Â  currentUser=null;
Â  Â  Â  document.getElementById('mainPanel').style.display='none';
Â  Â  Â  document.getElementById('loginPanel').style.display='block';
Â  Â  Â  document.getElementById('logoutBtn').style.display='none';
Â  Â  Â  await renderRanks();
Â  Â  Â  await updateHeaderUser();
Â  Â  Â  pingFirestore();
Â  Â  };

Â  Â  document.getElementById('resetProgress').onclick = async ()=>{
Â  Â  Â  if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
Â  Â  Â  await saveProgressForUser(currentUser, []);
Â  Â  Â  await applyLearnedFilterForCurrentUser();
Â  Â  Â  renderBySubject(currentSubject());
Â  Â  Â  await updateCounts();
Â  Â  Â  await renderRanks();
Â  Â  Â  await updateHeaderUser();
Â  Â  };

Â  Â  /* ================= ë¹ ë¥¸ 1ë‹¨ê³„ ë Œë” ================= */
Â  Â  async function quickRenderBase(){
Â  Â  Â  const base = await loadBase();
Â  Â  Â  const stdÂ  = standardize(base);
Â  Â  Â  raw = std.map((q,i)=>({...q,_idx:i}));

Â  Â  Â  await applyLearnedFilterForCurrentUser();
Â  Â  Â  initSubjectSelect();
Â  Â  Â  const sel = document.getElementById('subjectSelect');
Â  Â  Â  if(sel && !sel.value){
Â  Â  Â  Â  const subs = subjects();
Â  Â  Â  Â  if(subs.length) sel.value = subs[0];
Â  Â  Â  }
Â  Â  Â  renderBySubject(currentSubject());
Â  Â  Â  await updateCounts();
Â  Â  Â  await renderRanks();
Â  Â  Â  await updateHeaderUser();
Â  Â  }

Â  Â  /* ================= ì§ˆë¬¸ ëª¨ë‹¬ ================= */
Â  Â  function openQuestion(idx){
Â  Â  Â  currentIdx=idx;
Â  Â  Â  const q=raw.find(x=>x._idx===idx); if(!q) return;
Â  Â  Â  document.getElementById('qTitle').textContent=q.question;
Â  Â  Â  document.getElementById('userAnswer').textContent='';
Â  Â  Â  document.getElementById('result').innerHTML='';
Â  Â  Â  renderAnswerList();
Â  Â  Â  document.getElementById('extraInfo').value=q.extraInfo||'';
Â  Â  Â  renderFollowups();
Â  Â  Â  document.getElementById('qd').showModal();
Â  Â  Â  speak(q.question);
Â  Â  }
Â  Â  function closeQuestion(){
Â  Â  Â  if(recognition){ try{recognition.stop();}catch(_){ } recognition=null; }
Â  Â  Â  document.getElementById('qd').close();
Â  Â  }
Â  Â  window.openQuestion = openQuestion;
Â  Â  document.getElementById('closeBtn').onclick = closeQuestion;

Â  Â  /* ================= ìŒì„± í•©ì„±/ì¸ì‹ ================= */
Â  Â  function speak(txt){ const u=new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
Â  Â  document.getElementById('speakBtn').onclick = ()=>{ const q=raw.find(x=>x._idx===currentIdx); if(q) speak(q.question); };
Â  Â  document.getElementById('speakExtraInfoBtn').onclick = ()=>{
Â  Â  Â  const text = document.getElementById('extraInfo').value;
Â  Â  Â  if(text) speak(text);
Â  Â  };
Â  Â  function startRecognition(){
Â  Â  Â  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  Â  if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
Â  Â  Â  recognition=new SpeechRecognition();
Â  Â  Â  recognition.lang='ko-KR'; recognition.continuous=true; recognition.interimResults=true;
Â  Â  Â  let finalTranscript='';
Â  Â  Â  recognition.onresult=(event)=>{
Â  Â  Â  Â  let interim='';
Â  Â  Â  Â  for(let i=event.resultIndex;i<event.results.length;i++){
Â  Â  Â  Â  Â  const t=event.results[i][0].transcript;
Â  Â  Â  Â  Â  if(event.results[i].isFinal){ finalTranscript += t + ' '; } else { interim += t; }
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('userAnswer').textContent=(finalTranscript+interim).trim();
Â  Â  Â  };
Â  Â  Â  recognition.start();
Â  Â  }
Â  Â  document.getElementById('recordBtn').onclick = ()=>{
Â  Â  Â  document.getElementById('userAnswer').textContent='(ë…¹ìŒì¤‘...)';
Â  Â  Â  startRecognition();
Â  Â  };

Â  Â  /* ================= ìœ ì‚¬ë„ & ë‹µë³€ì™„ë£Œ ================= */
Â  Â  function similarity(a,b){
Â  Â  Â  const sa=new Set(String(a).split(/\s+/).filter(Boolean));
Â  Â  Â  const sb=new Set(String(b).split(/\s+/).filter(Boolean));
Â  Â  Â  let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
Â  Â  Â  return inter/(sa.size+sb.size-inter||1);
Â  Â  }
Â  Â  document.getElementById('submitBtn').onclick = ()=>{
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx);
Â  Â  Â  if(!q) return;
Â  Â  Â  const gold=(q.answers&&q.answers.length)? (q.answers[q.active||0]||q.answers[0]) : '';
Â  Â  Â  const user=document.getElementById('userAnswer').textContent;
Â  Â  Â  const sim=similarity(user,gold);
Â  Â  Â  if(!gold){
Â  Â  Â  Â  document.getElementById('result').innerHTML = `<div class='answer-box'>ì •ë‹µì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. <b>â€œì •ë‹µ ì¶”ê°€â€</b> ë²„íŠ¼ìœ¼ë¡œ ì •ë‹µì„ ë“±ë¡í•˜ì„¸ìš”.</div>`;
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  document.getElementById('result').innerHTML = `<div class='answer-box'>${esc(gold)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
Â  Â  Â  speak('ì •ë‹µì…ë‹ˆë‹¤. ' + gold);
Â  Â  };

Â  Â  /* ================= ìŠµë“ì™„ë£Œ ================= */
Â  Â  document.getElementById('learnedBtn').onclick = async ()=>{
Â  Â  Â  if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
Â  Â  Â  const q = raw.find(x=>x._idx===currentIdx); if(!q) return;
Â  Â  Â  const id = qKey(q);

Â  Â  Â  // ì¦‰ì‹œ UIì—ì„œ ì œê±°
Â  Â  Â  data = data.filter(item => qKey(item) !== id);
Â  Â  Â  renderBySubject(currentSubject());
Â  Â  Â  closeQuestion();

Â  Â  Â  // ì €ì¥
Â  Â  Â  try{
Â  Â  Â  Â  const all = await loadProgress();
Â  Â  Â  Â  const mine = new Set((all[currentUser]?.learnedIds || []));
Â  Â  Â  Â  mine.add(id);
Â  Â  Â  Â  await saveProgressForUser(currentUser, Array.from(mine));
Â  Â  Â  }catch(e){ console.warn('[learned] ì €ì¥ ì‹¤íŒ¨ â€“ ë¡œì»¬ ìœ ì§€', e); }

Â  Â  Â  // ê°±ì‹ 
Â  Â  Â  try{
Â  Â  Â  Â  await updateCounts();Â  Â  Â  // ê³¼ëª©ë³„ ì¹´ìš´íŠ¸
Â  Â  Â  Â  await updateHeaderUser();Â  // ìƒë‹¨ ì¤„
Â  Â  Â  Â  await renderRanks();Â  Â  Â  Â // ì²« í™”ë©´ ìˆœìœ„
Â  Â  Â  }catch(e){}
Â  Â  };

Â  Â  /* ================= ì •ë‹µ/ì„¤ëª…/ì¶”ê°€ì§ˆë¬¸ ê´€ë¦¬ ================= */
Â  Â  function renderAnswerList(){
Â  Â  Â  const holder=document.getElementById('extraAnswers');
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx);
Â  Â  Â  if(!q){ holder.innerHTML=''; return; }
Â  Â  Â  const items=(q.answers||[]).map((ans,i)=>{
Â  Â  Â  Â  const checked=(q.active||0)===i?'checked':'';
Â  Â  Â  Â  return `<div class="answer-list-item">
Â  Â  Â  Â  Â  <input type="radio" name="ansPick" value="${i}" ${checked} style="margin-top:4px"/>
Â  Â  Â  Â  Â  <div style="flex:1">${esc(ans)}</div>
Â  Â  Â  Â  Â  <button class="btn" data-edit-ans="${i}">âœï¸</button>
Â  Â  Â  Â  Â  <button class="btn danger" data-del-ans="${i}">ğŸ—‘</button>
Â  Â  Â  Â  </div>`;
Â  Â  Â  }).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  holder.innerHTML = `<div class="answer-controls">
Â  Â  Â  Â  <h3>ì •ë‹µ ëª©ë¡</h3>
Â  Â  Â  Â  <button id="addAnswerBtn" class="btn">â• ì •ë‹µ ì¶”ê°€</button>
Â  Â  Â  </div>` + items;

Â  Â  Â  // Add event listeners for new buttons
Â  Â  Â  document.getElementById('addAnswerBtn').onclick = async ()=>{
Â  Â  Â  Â  const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
Â  Â  Â  Â  q.answers=q.answers||[];
Â  Â  Â  Â  if(!q.answers.includes(val)) q.answers.push(val);
Â  Â  Â  Â  q.active=q.answers.length-1;
Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  renderAnswerList();
Â  Â  Â  };

Â  Â  Â  holder.querySelectorAll('input[name="ansPick"]').forEach(r=>{
Â  Â  Â  Â  r.addEventListener('change', async (e)=>{
Â  Â  Â  Â  Â  q.active = parseInt(e.target.value,10)||0;
Â  Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  holder.querySelectorAll('[data-del-ans]').forEach(btn=>{
Â  Â  Â  Â  btn.addEventListener('click', async ()=>{
Â  Â  Â  Â  Â  const i=parseInt(btn.getAttribute('data-del-ans'),10);
Â  Â  Â  Â  Â  q.answers.splice(i,1);
Â  Â  Â  Â  Â  if((q.active||0)>=q.answers.length) q.active=Math.max(0,q.answers.length-1);
Â  Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  Â  renderAnswerList();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  holder.querySelectorAll('[data-edit-ans]').forEach(btn=>{
Â  Â  Â  Â  btn.addEventListener('click', async ()=>{
Â  Â  Â  Â  Â  const i=parseInt(btn.getAttribute('data-edit-ans'),10);
Â  Â  Â  Â  Â  const newAns=prompt('ì •ë‹µì„ ìˆ˜ì •í•˜ì„¸ìš”', q.answers[i]);
Â  Â  Â  Â  Â  if(newAns!==null && newAns.trim()!==''){
Â  Â  Â  Â  Â  Â  q.answers[i]=newAns.trim();
Â  Â  Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  Â  Â  renderAnswerList();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }
Â  Â  // The addAnswerBtn is now part of renderAnswerList, so this is removed
Â  Â  // document.getElementById('addAnswerBtn').onclick = ...

Â  Â  document.getElementById('saveExtraInfoBtn').onclick = async ()=>{
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
Â  Â  Â  q.extraInfo=(document.getElementById('extraInfo').value||'').trim();
Â  Â  Â  await persistQuestion(q);
Â  Â  Â  alert('ì¶”ê°€ì„¤ëª…ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
Â  Â  };
Â  Â  (function(){
Â  Â  Â  const btn = document.getElementById('expandExtraInfoBtn');
Â  Â  Â  let expanded=false;
Â  Â  Â  const ta=document.getElementById('extraInfo');
Â  Â  Â  ta.style.maxHeight='50vh';
Â  Â  Â  ta.style.minHeight='80px';
Â  Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  Â  expanded=!expanded;
Â  Â  Â  Â  if(expanded){
Â  Â  Â  Â  Â  ta.style.maxHeight='80vh';
Â  Â  Â  Â  Â  ta.style.minHeight='60vh';
Â  Â  Â  Â  Â  btn.textContent='ğŸ” ì ‘ê¸°';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  ta.style.maxHeight='50vh';
Â  Â  Â  Â  Â  ta.style.minHeight='80px';
Â  Â  Â  Â  Â  btn.textContent='ğŸ” ì „ì²´ë³´ê¸°';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  })();
Â  Â  function renderFollowups(){
Â  Â  Â  const box=document.getElementById('followupsBox');
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx);
Â  Â  Â  if(!q){ box.innerHTML=''; return; }
Â  Â  Â  const items=(q.followups||[]).map((f,i)=>`<div style="display:flex;gap:8px;flex-direction:column;border:1px solid #1f2a55;border-radius:10px;padding:8px;margin:6px 0">
Â  Â  Â  Â  <div><b class="followup-q">Q${i+1}.</b> ${esc(f.q)}</div>
Â  Â  Â  Â  <div><b>A${i+1}.</b> ${esc(f.a)}</div>
Â  Â  Â  Â  <div style="align-self: flex-end; display: flex; gap: 8px;">
Â  Â  Â  Â  Â  <button class='btn' data-edit-fu='${i}'>âœï¸ í¸ì§‘</button>
Â  Â  Â  Â  Â  <button class='btn danger' data-del-fu='${i}'>ğŸ—‘ ì‚­ì œ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>`).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì¶”ê°€ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  box.innerHTML=items;
Â  Â  Â  box.querySelectorAll('[data-del-fu]').forEach(btn=>{
Â  Â  Â  Â  btn.addEventListener('click', async ()=>{
Â  Â  Â  Â  Â  const i=parseInt(btn.getAttribute('data-del-fu'),10);
Â  Â  Â  Â  Â  q.followups.splice(i,1);
Â  Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  Â  renderFollowups();
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  box.querySelectorAll('[data-edit-fu]').forEach(btn=>{
Â  Â  Â  Â  btn.addEventListener('click', async ()=>{
Â  Â  Â  Â  Â  const i=parseInt(btn.getAttribute('data-edit-fu'),10);
Â  Â  Â  Â  Â  const newQ=prompt('ì§ˆë¬¸ì„ ìˆ˜ì •í•˜ì„¸ìš”', q.followups[i].q);
Â  Â  Â  Â  Â  const newA=prompt('ë‹µë³€ì„ ìˆ˜ì •í•˜ì„¸ìš”', q.followups[i].a);
Â  Â  Â  Â  Â  if(newQ!==null && newA!==null && newQ.trim()!=='' && newA.trim()!==''){
Â  Â  Â  Â  Â  Â  q.followups[i].q=newQ.trim();
Â  Â  Â  Â  Â  Â  q.followups[i].a=newA.trim();
Â  Â  Â  Â  Â  Â  await persistQuestion(q);
Â  Â  Â  Â  Â  Â  renderFollowups();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }
Â  Â  document.getElementById('addFollowupBtn').onclick = async ()=>{
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
Â  Â  Â  const fq=(document.getElementById('fuQ').value||'').trim();
Â  Â  Â  const fa=(document.getElementById('fuA').value||'').trim();
Â  Â  Â  if(!fq||!fa){ alert('ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
Â  Â  Â  q.followups=q.followups||[];
Â  Â  Â  q.followups.push({q:fq,a:fa});
Â  Â  Â  document.getElementById('fuQ').value=''; document.getElementById('fuA').value='';
Â  Â  Â  await persistQuestion(q);
Â  Â  Â  renderFollowups();
Â  Â  };

Â  Â  /* ================= ì§ˆë¬¸ ì¶”ê°€/ì‚­ì œ(ê³µìœ ) ================= */
Â  Â  document.getElementById('addQuestionBtn').onclick = async ()=>{
Â  Â  Â  const subj=prompt('ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!subj) return;
Â  Â  Â  const ques=prompt('ìƒˆ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!ques) return;
Â  Â  Â  const answ=prompt('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!answ) return;
Â  Â  Â  const id = `${normSubj(subj)}::${ques}`;
Â  Â  Â  if(raw.some(x=> qKey(x)===id)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸í•­ì…ë‹ˆë‹¤.'); return; }
Â  Â  Â  const seed = {
Â  Â  Â  Â  subject:normSubj(subj),
Â  Â  Â  Â  question:ques,
Â  Â  Â  Â  answers:[answ],
Â  Â  Â  Â  active:0,
Â  Â  Â  Â  extraInfo: `â— ì§ˆë¬¸ ì˜ë„: â€œ${ques}â€\nâ— ë‹µë³€ êµ¬ì¡°: (ì •ì˜)â†’(í•µì‹¬)â†’(ì‚¬ë¡€)â†’(ë³´ì™„)\nâ— ë§ë¨¸ë¦¬: ê²°ë¡ â†’ê·¼ê±° 2~3â†’ì‚¬ë¡€â†’ìš”ì•½`,
Â  Â  Â  Â  followups: [
Â  Â  Â  Â  Â  { q:'í˜„ì¥ ì ìš© ì‚¬ë¡€?', a:'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ ê°„ë‹¨ ì„¤ëª…' },
Â  Â  Â  Â  Â  { q:'ê´€ë ¨ ì§€ì¹¨/ìœ¤ë¦¬ëŠ”?', a:'í•µì‹¬ ì¡°í•­ê³¼ ì—°ê²° ì´ìœ  1~2ë¬¸ì¥' }
Â  Â  Â  Â  ]
Â  Â  Â  };
Â  Â  Â  const current = await loadShared();
Â  Â  Â  current.push(seed);
Â  Â  Â  await saveShared(current);
Â  Â  Â  await bootstrap();
Â  Â  };
Â  Â  document.getElementById('deleteQuestionBtn').onclick = async ()=>{
Â  Â  Â  const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
Â  Â  Â  if(!confirm('ì´ ì§ˆë¬¸ì„ ëª¨ë“  ì‚¬ìš©ìì—ê²Œì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
Â  Â  Â  await deleteSharedQuestion(q);
Â  Â  Â  await bootstrap();
Â  Â  Â  closeQuestion();
Â  Â  };

Â  Â  /* ================= ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ================= */
Â  Â  (function(){
Â  Â  Â  const exportBtn = document.getElementById('exportBtn');
Â  Â  Â  const importBtn = document.getElementById('importBtn');
Â  Â  Â  const importFile = document.getElementById('importFile');

Â  Â  Â  function download(filename, text){
Â  Â  Â  Â  const blob = new Blob([text], {type: 'application/json;charset=utf-8'});
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = url; a.download = filename;
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  a.remove();
Â  Â  Â  }

Â  Â  Â  async function exportAll(){
Â  Â  Â  Â  const shared = await loadShared();
Â  Â  Â  Â  const progress = await loadProgress();
Â  Â  Â  Â  const payload = { version: 2, exportedAt: new Date().toISOString(), shared, progress };
Â  Â  Â  Â  download('youth-interview-backup.json', JSON.stringify(payload,null,2));
Â  Â  Â  Â  alert('ë‚´ë³´ë‚´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
Â  Â  Â  }

Â  Â  Â  async function importAll(file){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const text = await file.text();
Â  Â  Â  Â  Â  const obj = JSON.parse(text);
Â  Â  Â  Â  Â  if(typeof obj !== 'object' || obj === null) throw new Error('JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
Â  Â  Â  Â  Â  if(!('shared' in obj) || !('progress' in obj)) throw new Error('shared/progress í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  Â  if(!Array.isArray(obj.shared)) throw new Error('sharedëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
Â  Â  Â  Â  Â  if(typeof obj.progress !== 'object') throw new Error('progressëŠ” ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
Â  Â  Â  Â  Â  if(!confirm('í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì“°ê¸°/ë³‘í•©ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;

Â  Â  Â  Â  Â  await saveShared(obj.shared);
Â  Â  Â  Â  Â  const names = Object.keys(obj.progress||{});
Â  Â  Â  Â  Â  for(const name of names){
Â  Â  Â  Â  Â  Â  const learned = Array.from(new Set((obj.progress[name]?.learnedIds)||[]));
Â  Â  Â  Â  Â  Â  await saveProgressForUser(name, learned);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  await bootstrap();
Â  Â  Â  Â  Â  alert('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message||e));
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if(exportBtn) exportBtn.addEventListener('click', exportAll);
Â  Â  Â  if(importBtn && importFile){
Â  Â  Â  Â  importBtn.addEventListener('click', ()=> importFile.click());
Â  Â  Â  Â  importFile.addEventListener('change', (e)=>{
Â  Â  Â  Â  Â  const f = e.target.files && e.target.files[0];
Â  Â  Â  Â  Â  if(f) importAll(f);
Â  Â  Â  Â  Â  e.target.value = '';
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  })();

Â  Â  /* ================= ë¶€íŠ¸ìŠ¤íŠ¸ë© ================= */
Â  Â  async function bootstrap(){
Â  Â  Â  const base=await loadBase();
Â  Â  Â  const std = standardize(base);
Â  Â  Â  await mergeWithShared(std);
Â  Â  Â  await applyLearnedFilterForCurrentUser();
Â  Â  Â  initSubjectSelect();
Â  Â  Â  renderBySubject(currentSubject());
Â  Â  Â  await updateCounts();
Â  Â  Â  await renderRanks();
Â  Â  Â  await updateHeaderUser();
Â  Â  }

Â  Â  // ì´ˆê¸°: ë¡œê·¸ì¸ ì „ì—ë„ ìˆœìœ„(ê´€ë¦¬ì ì œì™¸) ë¨¼ì € ë³´ì—¬ì¤Œ
Â  Â  (async () => {
Â  Â  Â  const base = await loadBase();
Â  Â  Â  const stdÂ  = standardize(base);
Â  Â  Â  raw = std.map((q,i)=>({...q,_idx:i}));
Â  Â  Â  await renderRanks();
Â  Â  })();
Â  </script>
</body>
</html>
